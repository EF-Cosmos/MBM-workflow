# 性能优化指南 (Performance Optimization)

MBM-workflow 插件旨在处理大规模 Minecraft 地图数据。本指南介绍了如何优化导入、编辑和渲染性能。

## 1. 导入性能优化

### 多进程并行处理
插件内置了多进程支持，用于加速大型 `.schem` 文件的解析。
- **自动触发**: 当检测到方块数量 > 1,000,000 时，插件会自动尝试使用多核 CPU 处理数据。
- **手动分块**: 在导入面板勾选 **“按区块分离” (Separate by Chunk)**。这会将大地图拆分为多个 16x16 的小对象，虽然对象数量增加，但能避免单个网格过大导致 Blender 编辑模式卡死。

### 内存管理
- **关闭撤销 (Undo)**: 对于极大型导入（如 > 1GB 文件），建议在 Blender 设置中临时减少 Undo Steps，释放内存。
- **清理缓存**: 定期删除插件目录下的 `temp/` 和 `schemcache/` 文件夹，防止临时文件占用过多磁盘空间。

---

## 2. 网格优化 (Mesh Optimization)

这是提升渲染帧率（FPS）最关键的步骤。

### 合并重叠面 (Merge Overlapping Faces)
Minecraft 地图中，相邻方块之间存在大量不可见的接触面。
- **原理**: 算法检测两个面是否位置重合且法线相反。
- **操作**: 选中对象 -> 侧边栏 -> 导入面板 -> 点击 **“合并重叠面”**。
- **效果**: 通常可减少 40% - 60% 的多边形数量。

### 顶点合并 (Weld)
- **操作**: 在导入前勾选 **“合并重叠顶点”**。
- **作用**: 移除重复顶点，使网格拓扑更干净，有利于后续的平滑着色或物理计算。

### 几何节点烘焙
- **原理**: 默认情况下，方块是通过几何节点实时实例化的。这在编辑时很灵活，但对显卡压力大。
- **优化**: 如果不需要再编辑方块类型，可以应用 (Apply) 几何节点修改器，将其转为静态网格，大幅提升视口性能。

---

## 3. 渲染性能优化

### 视口显示
- **剔除流体**: 水和岩浆通常占据大量面数。如果只是为了预览建筑，可以在 `classification_files/block_type.py` 中调整过滤列表。
- **降低实例密度**: 对于树叶等大量重复的物体，可在几何节点中设置距离剔除（LOD）。

### 材质优化
- **纹理合并**: 插件默认为每个方块生成独立材质。对于超大型场景，建议使用 Blender 的烘焙功能将材质合并为一张图集 (Atlas)，减少 Draw Calls。

---

## 4. 开发者建议

如果你在编写脚本扩展本插件：

### 避免全网格遍历
不要在 Python 循环中遍历 `mesh.vertices`。
- **错误**: `for v in mesh.vertices: ...` (Python 层面循环慢)
- **正确**: 使用 `foreach_get` 和 `foreach_set` 结合 NumPy 进行批量数据操作。

### 使用 KDTree 进行查找
在进行空间搜索（如笔刷或颜色匹配）时，使用 `mathutils.kdtree.KDTree` 代替暴力距离计算。插件中的 `paint_block` 操作符就是一个很好的例子。

```python
# 示例：高效构建 KDTree
kd = KDTree(len(target_colors))
for i, color in enumerate(color_list):
    kd.insert(Vector(color), i)
kd.balance()
```
